From 4f73dfdf46a56df4ea999c93033e907d6d181235 Mon Sep 17 00:00:00 2001
From: Michael J Rubinsky <mrubinsk@horde.org>
Date: Thu, 6 Dec 2018 10:50:35 -0500
Subject: [PATCH] Protect against fatal error if requesting attachment that
 doesn't exist.

---
 lib/Contents.php            | 3 +++
 lib/Minimal/Messagepart.php | 7 +++++--
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/lib/Contents.php b/lib/Contents.php
index c645e47ba..a050c4e13 100644
--- a/lib/Contents.php
+++ b/lib/Contents.php
@@ -802,6 +802,9 @@ class IMP_Contents
         );
 
         $mime_part = $this->getMIMEPart($id, array('nocontents' => true));
+        if (empty($mime_part)) {
+            throw new IMP_Exception('MIME Part not found.');
+        }
         $mime_type = $mime_part->getType();
 
         /* If this is an attachment that has no specific MIME type info, see
diff --git a/lib/Minimal/Messagepart.php b/lib/Minimal/Messagepart.php
index e0cf7e465..202d6ffbb 100644
--- a/lib/Minimal/Messagepart.php
+++ b/lib/Minimal/Messagepart.php
@@ -32,8 +32,11 @@ class IMP_Minimal_Messagepart extends IMP_Minimal_Base
         }
 
         if (isset($this->vars->atc)) {
-            $summary = $imp_contents->getSummary($this->vars->atc, IMP_Contents::SUMMARY_SIZE | IMP_Contents::SUMMARY_DESCRIP | IMP_Contents::SUMMARY_DOWNLOAD);
-
+            try {
+                $summary = $imp_contents->getSummary($this->vars->atc, IMP_Contents::SUMMARY_SIZE | IMP_Contents::SUMMARY_DESCRIP | IMP_Contents::SUMMARY_DOWNLOAD);
+            } catch (IMP_Exception $e) {
+                IMP_Minimal_Mailbox::url(array('mailbox' => $this->indices->mailbox))->add('a', 'm')->redirect();
+            }
             $this->title = _("Download Attachment");
 
             $this->view->descrip = $summary['description_raw'];
-- 
2.15.1

