var frames={horde_main:true},DimpCore={server_error:0,buttons:["button_reply","button_forward","button_spam","button_ham","button_deleted"],doActionOpts:{onException:function(A,B){DimpCore.debug("onException",B)},onFailure:function(A,B){DimpCore.debug("onFailure",A)},evalJS:false,evalJSON:true},debug:function(A,B){if(!this.is_logout&&DIMP.conf.debug){alert(A+": "+((B instanceof Error&&B.name&&B.message)?B.name+"-"+B.message:Object.inspect(B))+(B.lineNumber?" (Line #"+B.lineNumber+")":""))}},toRangeString:function(A){var B="";$H(A).each(function(F){if(!F.value.size()){return}var D=F.value.numericSort(),E=last=D.shift(),C=[];D.each(function(G){if(last+1==G){last=G}else{C.push(E+(last==E?"":(":"+last)));E=last=G}});C.push(E+(last==E?"":(":"+last)));B+="{"+F.key.length+"}"+F.key+C.join(",")});return B},parseRangeString:function(G){var E,B,C,F,A={},D=[];G=G.strip();while(!G.blank()){if(!G.startsWith("{")){break}C=G.indexOf("}");E=Number(G.substr(1,C-1));F=G.substr(C+1,E);C+=E+1;B=G.indexOf("{",C);if(B==-1){uidstr=G.substr(C);G=""}else{uidstr=G.substr(C,B-C);G=G.substr(B)}uidstr.split(",").each(function(I){var H=I.split(":");if(H.size()==1){D.push(Number(I))}else{D=D.concat($A($R(Number(H[0]),Number(H[1]))))}});A[F]=D}return A},doAction:function(E,F,D,G,C){var A,B={};C=Object.extend(this.doActionOpts,C||{});F=$H(F);E=E.startsWith("*")?E.substring(1):DIMP.conf.URI_IMP+"/"+E;if(D){if(D.viewport_selection){A=D.getBuffer();if(A.getMetaData("search")){D.get("dataob").each(function(H){if(!B[H.view]){B[H.view]=[]}B[H.view].push(H.imapuid)})}else{B[A.getView()]=D.get("uid")}D=B}F.set("uid",this.toRangeString(D))}if(DIMP.conf.SESSION_ID){F.update(DIMP.conf.SESSION_ID.toQueryParams())}C.parameters=F.toQueryString();C.onComplete=function(H,I){this.doActionComplete(H,G)}.bind(this);new Ajax.Request(E,C)},doActionComplete:function(B,D){this.inAjaxCallback=true;var A;if(!B.responseJSON){if(++this.server_error==3){this.showNotifications([{type:"horde.error",message:DIMP.text.ajax_timeout}])}this.inAjaxCallback=false;return}A=B.responseJSON;if(!A.msgs){A.msgs=[]}if(A.response&&Object.isFunction(D)){if(DIMP.conf.debug){D(A)}else{try{D(A)}catch(C){}}}if(this.server_error>=3){A.msgs.push({type:"horde.success",message:DIMP.text.ajax_recover})}this.server_error=0;if(!A.msgs_noauto){this.showNotifications(A.msgs)}if(this.onDoActionComplete){this.onDoActionComplete(A)}this.inAjaxCallback=false},setTitle:function(A){document.title=DIMP.conf.name+" :: "+A},showNotifications:function(A){if(!A.size()||this.is_logout){return}A.find(function(B){switch(B.type){case"dimp.timeout":this.logout(DIMP.conf.timeout_url);return true;case"horde.error":case"horde.message":case"horde.success":case"horde.warning":case"imp.reply":case"imp.forward":case"imp.redirect":case"dimp.request":case"dimp.sticky":var E,D,C,G=$("hordeAlerts"),H=new Element("DIV",{className:B.type.replace(".","-")}),F=B.message;if(!G){G=new Element("DIV",{id:"hordeAlerts"});$(document.body).insert(G)}if($w("dimp.request dimp.sticky").indexOf(B.type)==-1){F=F.unescapeHTML().unescapeHTML()}G.insert(H.update(F));if(DIMP.conf.is_ie6){E=new Element("DIV",{id:"hordeIE6AlertsFix"}).clonePosition(H,{setLeft:false,setTop:false});E.insert(H.remove());G.insert(E)}if($w("horde.error dimp.request dimp.sticky").indexOf(B.type)==-1){this.alertsFade.bind(this,H).delay(B.type=="horde.warning"?10:3)}if(B.type=="dimp.request"){this.alertrequest=H}if(C=$("hordeAlertslog")){switch(B.type){case"horde.error":D=DIMP.text.alog_error;break;case"horde.message":D=DIMP.text.alog_message;break;case"horde.success":D=DIMP.text.alog_success;break;case"horde.warning":D=DIMP.text.alog_warning;break}if(D){C=C.down("DIV UL");if(C.down().hasClassName("hordeNoalerts")){C.down().remove()}C.insert(new Element("LI").insert(new Element("P",{className:"label"}).insert(D)).insert(new Element("P",{className:"indent"}).insert(F).insert(new Element("SPAN",{className:"alertdate"}).insert("["+(new Date).toLocaleString()+"]"))))}}}},this)},alertsFade:function(A){if(A){Effect.Fade(A,{duration:1.5,afterFinish:this.removeAlert.bind(this)})}},toggleAlertsLog:function(){var A=$("alertsloglink").down("A"),C=$("hordeAlertslog").down("DIV"),B={duration:0.5,queue:{position:"end",scope:"hordeAlertslog",limit:2}};if(C.visible()){Effect.BlindUp(C,B);A.update(DIMP.text.showalog)}else{Effect.BlindDown(C,B);A.update(DIMP.text.hidealog)}},removeAlert:function(C){try{var A=$(C.element),B=A.up();A.remove();if(!B.childElements().size()&&B.readAttribute("id")=="hordeIE6AlertsFix"){B.remove()}}catch(D){this.debug("removeAlert",D)}},compose:function(C,B){var A=DIMP.conf.compose_url;B=B||{};if(C){B.type=C}this.popupWindow(this.addURLParam(A,B),"compose"+new Date().getTime())},popupWindow:function(B,A){if(!(window.open(B,A.replace(/\W/g,"_"),"width="+DIMP.conf.popup_width+",height="+DIMP.conf.popup_height+",status=1,scrollbars=yes,resizable=yes"))){this.showNotifications([{type:"horde.warning",message:DIMP.text.popup_block}])}},closePopup:function(){if(this.inAjaxCallback){this.closePopup.bind(this).defer()}else{window.close()}},logout:function(A){this.is_logout=true;this.redirect(A||(DIMP.conf.URI_IMP+"/LogOut"))},redirect:function(A){A=this.addURLParam(A);if(parent.frames.horde_main){parent.location=A}else{window.location=A}},buildAddressLinks:function(D,A){var E,C,B=D.size();if(B>15){C=$("largeaddrspan").cloneNode(true);C.writeAttribute("id","largeaddrspan_active");A.insert(C);E=C.down(".dispaddrlist");C=C.down(1);C.setText(C.getText().replace("%d",B))}else{E=A}D.each(function(I,H){var F,G;if(I.raw){F=I.raw}else{G=I.personal?(I.personal+" <"+I.inner+">"):I.inner;F=new Element("A",{className:"address",personal:I.personal,email:I.inner,address:G}).insert(G.escapeHTML());this.DMenu.addElement(F.identify(),"ctx_contacts",{offset:F,left:true})}E.insert(F);if(H+1!=B){E.insert(", ")}},this);return A},removeAddressLinks:function(A){A.select(".address").each(function(B){this.DMenu.removeElement(B.identify())},this)},addURLParam:function(A,C){var B=A.indexOf("?");C=$H(C);if(DIMP.conf.SESSION_ID){C.update(DIMP.conf.SESSION_ID.toQueryParams())}if(B!=-1){C.update(A.toQueryParams());A=A.substring(0,B)}return C.size()?(A+"?"+C.toQueryString()):A},reloadMessage:function(A){if(typeof DimpFullmessage!="undefined"){window.location=this.addURLParam(document.location.href,A)}else{DimpBase.loadPreview(null,A)}},_clickHandler:function(D){if(D.isRightClick()){return}var A=D.element(),E,C,B;if(this.alertrequest){this.alertsFade(this.alertrequest);this.alertrequest=null}while(Object.isElement(A)){E=A.readAttribute("id");switch(E){case"partlist_toggle":B=$("partlist");$("partlist_col","partlist_exp").invoke("toggle");C={duration:0.2,queue:{position:"end",scope:"partlist",limit:2}};if(B.visible()){Effect.BlindUp(B,C)}else{Effect.BlindDown(B,C)}D.stop();return;case"msg_print":window.print();D.stop();return;case"msg_view_source":this.popupWindow(this.addURLParam(DIMP.conf.URI_VIEW,{index:DIMP.conf.msg_index,mailbox:DIMP.conf.msg_folder,actionID:"view_source",id:0},true),DIMP.conf.msg_index+"|"+DIMP.conf.msg_folder);break;case"ctx_contacts_new":this.compose("new",{to:this.DMenu.element().readAttribute("address")});break;case"ctx_contacts_add":this.doAction("AddContact",{name:this.DMenu.element().readAttribute("personal"),email:this.DMenu.element().readAttribute("email")},null,true);break;case"alertsloglink":this.toggleAlertsLog();break;case"hordeAlerts":this.alertsFade(A);break;case"largeaddrspan_active":B=A.down();[B.down(),B.down(1),B.next()].invoke("toggle");break}A=A.up()}}};if(typeof ContextSensitive!="undefined"){DimpCore.DMenu=new ContextSensitive()}document.observe("dom:loaded",function(){try{if(parent.opener&&parent.opener.location.host==window.location.host&&parent.opener.DimpCore){DIMP.baseWindow=parent.opener.DIMP.baseWindow||parent.opener}}catch(A){}if(!DIMP.conf.spam_reporting){DimpCore.buttons=DimpCore.buttons.without("button_spam")}if(!DIMP.conf.ham_reporting){DimpCore.buttons=DimpCore.buttons.without("button_ham")}document.observe("click",DimpCore._clickHandler.bindAsEventListener(DimpCore))});Event.observe(window,"load",function(){DimpCore.window_load=true});Element.addMethods({setText:function(B,C){var A=0;$A(B.childNodes).each(function(D){if(D.nodeType==3){if(A++){Element.remove(D)}else{D.nodeValue=C}}});if(!A){$(B).insert(C)}},getText:function(B,A){var C="";$A(B.childNodes).each(function(D){if(D.nodeType==3){C+=D.nodeValue}else{if(A&&D.hasChildNodes()){C+=$(D).getText(true)}}});return C}});Object.extend(Array.prototype,{numericSort:function(){return this.collect(Number).sort(function(B,A){if(B>A){return 1}else{if(B<A){return-1}}return 0})}});Object.extend(String.prototype,{evalScripts:function(){var re=/function\s+([^\s(]+)/g;this.extractScripts().each(function(s){var func;eval(s);while(func=re.exec(s)){window[func[1]]=eval(func[1])}})}});