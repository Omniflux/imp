var ImpCompose={display_unload_warning:true,textarea_ready:true,confirmCancel:function(a){if(window.confirm(IMP.text.compose_cancel)){this.display_unload_warning=false;if(this.popup){if(this.cancel_url){self.location=this.cancel_url}else{self.close()}}else{window.location=this.cancel_url}}else{a.stop()}},setCursorPosition:function(c,a){if(c.setSelectionRange){Field.focus(c);c.setSelectionRange(a,a)}else{if(c.createTextRange){var b=c.createTextRange();b.collapse(true);b.moveStart("character",a);b.moveEnd("character",0);Field.select(b);b.scrollIntoView(true)}}},changeIdentity:function(c){var a=$F(c),n=this.identities[$F("last_identity")],e=this.identities[a],d=0,h=$("bcc"),k=$("ssm"),j=$("sent_mail_folder"),f,g,b,m,l,o;if(this.rtemode){f=FCKeditorAPI.GetInstance("message");b=f.GetHTML.replace(/\r\n/g,"\n");g="<p><!--begin_signature--><!--end_signature--></p>";m="<p><!--begin_signature-->"+e[0].replace(/^ ?<br \/>\n/,"").replace(/ +/g," ")+"<!--end_signature--></p>";b=b.replace(/<p class="imp-signature">\s*<!--begin_signature-->[\s\S]*?<!--end_signature-->\s*<\/p>/,g)}else{b=$F("message").replace(/\r\n/g,"\n");g=n[0].replace(/^\n/,"");m=e[0].replace(/^\n/,"")}l=(n[1])?b.indexOf(g):b.lastIndexOf(g);if(l!=-1){if(e[1]==n[1]){b=b.substring(0,l)+m+b.substring(l+g.length,b.length)}else{if(e[1]){b=m+b.substring(0,l)+b.substring(l+g.length,b.length)}else{b=b.substring(0,l)+b.substring(l+g.length,b.length)+m}}b=b.replace(/\r\n/g,"\n").replace(/\n/g,"\r\n");$("last_identity").setValue(a);window.status=IMP.text.compose_sigreplace}else{window.status=IMP.text.compose_signotreplace}if(this.rtemode){f.SetHTML(b)}else{$("message").setValue(b)}if(this.smf_check){$A(j.options).detect(function(i){if(i.value==e[2]){j.selectedIndex=d;return true}++d})}else{if(j.firstChild){j.replaceChild(document.createTextNode(e[2]),j.firstChild)}else{j.appendChild(document.createTextNode(e[2]))}}if(k){k.checked=e[3]}if(h){bccval=h.value;if(n[4]){o=new RegExp(n[4]+",? ?","gi");bccval=bccval.replace(o,"");if(bccval){bccval=bccval.replace(/, ?$/,"")}}if(e[4]){if(bccval){bccval+=", "}bccval+=e[4]}h.setValue(bccval)}},uniqSubmit:function(b,a){a.stop();if(b=="redirect"){if($F("to")==""){alert(IMP.text.compose_recipient);$("to").focus()}else{if(!Prototype.Browser.WebKit){$("redirect").setStyle({cursor:"wait"})}this.display_unload_warning=false}return}if(b=="send_message"){if(($F("subject")=="")&&!window.confirm(IMP.text.compose_nosubject)){return}if(this.spellcheck&&IMP.SpellCheckerObject&&!IMP.SpellCheckerObject.isActive()){IMP.SpellCheckerObject.spellCheck();return}}if(IMP.SpellCheckerObject){IMP.SpellCheckerObject.resume()}if(!Prototype.Browser.WebKit){$("compose").setStyle({cursor:"wait"})}this.display_unload_warning=false;$("actionID").setValue(b);this._uniqSubmit()},_uniqSubmit:function(){if(this.textarea_ready){$("compose").submit()}else{this._uniqSubmit.defer()}},attachmentChanged:function(){var a=[],d=0,c,b,e;$("upload_atc").select('input[type="file"]').each(function(f){a[a.length]=f});if(this.max_attachments!==null&&a.length==this.max_attachments){return}a.each(function(f){if(f.value.length>0){d++}});if(d==a.length){c=$("attachment_row_"+d);if(c){e=new Element("TD",{align:"left"}).insert(new Element("STRONG").insert(IMP.text.compose_file+" "+(d+1)+":")).insert("&nbsp;");e.insert(new Element("INPUT",{type:"file",name:"upload_"+(d+1),size:25}));b=new Element("TR",{id:"attachment_row_"+(d+1)}).insert(e);c.parentNode.insertBefore(b,c.nextSibling)}}},initializeSpellChecker:function(){if(typeof IMP.SpellCheckerObject!="object"){this.initializeSpellChecker.defer();return}IMP.SpellCheckerObject.onBeforeSpellCheck=this._beforeSpellCheck.bind(this);IMP.SpellCheckerObject.onAfterSpellCheck=this._afterSpellCheck.bind(this)},_beforeSpellCheck:function(){IMP.SpellCheckerObject.htmlAreaParent="messageParent";IMP.SpellCheckerObject.htmlArea=$("message").adjacent("iframe[id*=message]").first();$("message").setValue(FCKeditorAPI.GetInstance("message").GetHTML());this.textarea_ready=false},_afterSpellCheck:function(){IMP.SpellCheckerObject.htmlArea=IMP.SpellCheckerObject.htmlAreaParent=null;var a=FCKeditorAPI.GetInstance("message");a.SetHTML($("message").value);a.Events.AttachEvent("OnAfterSetHTML",this._afterSetHTML.bind(this))},_afterSetHTML:function(){this.textarea_ready=true},clickHandler:function(c){var b=c.element(),a;if(b.hasClassName("button")){a=b.readAttribute("name");switch(a){case"btn_add_attachment":case"btn_redirect":case"btn_save_draft":case"btn_send_message":this.uniqSubmit(a.substring(4),c);break;case"btn_cancel_compose":this.confirmCancel(c);break}}},changeHandler:function(b){var a=b.element(),c=a.readAttribute("id");switch(c){case"identity":this.changeIdentity(a);break;case"stationery":this.uniqSubmit("change_stationery",b);break;case"sent_mail_folder":$("ssm").writeAttribute("checked","checked");break;default:if(c.substring(0,7)=="upload_"){this.attachmentChanged()}break}},onDomLoad:function(){$$("INPUT").each(function(a){if(a.type!="submit"&&a.type!="button"){a.observe("keydown",function(b){if(b.keyCode==10||b.keyCode==Event.KEY_RETURN){b.stop();return false}})}});if(this.cursor_pos!==null&&$("message")){this.setCursorPosition($("message"),this.cursor_pos)}if(this.redirect){$("to").focus()}else{if(Prototype.Browser.IE){$("subject").observe("keydown",function(a){if(a.keyCode==Event.KEY_TAB&&!a.shiftKey){a.stop();$("message").focus()}})}if(this.rtemode){this.initializeSpellChecker()}if($("to")&&!$F("to")){$("to").focus()}else{if(!$F("subject")){if(this.rtemode){$("subject").focus()}else{$("message").focus()}}}}},onLoad:function(){var b,a=this.redirect?$("redirect"):$("compose");if(this.popup&&!this.reloaded){b=Math.min(a.getHeight(),screen.height-100)-document.viewport.getHeight();if(b>0){window.resizeBy(0,b)}}document.observe("click",this.clickHandler.bindAsEventListener(this));document.observe("change",this.changeHandler.bindAsEventListener(this))},onBeforeUnload:function(){if(this.display_unload_warning){return IMP.text.compose_discard}}};document.observe("dom:loaded",ImpCompose.onDomLoad.bind(ImpCompose));Event.observe(window,"load",ImpCompose.onLoad.bind(ImpCompose));Event.observe(window,"beforeunload",ImpCompose.onBeforeUnload.bind(ImpCompose));