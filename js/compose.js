var display_unload_warning=true,textarea_ready=true;function confirmCancel(a){if(window.confirm(IMP.text.compose_cancel)){display_unload_warning=false;if(popup){if(cancel_url){self.location=cancel_url}else{self.close()}}else{window.location=cancel_url}return true}else{Event.extend(a);a.stop();return false}}function setCursorPosition(c,a){if(c.setSelectionRange){Field.focus(c);c.setSelectionRange(a,a)}else{if(c.createTextRange){var b=c.createTextRange();b.collapse(true);b.moveStart("character",a);b.moveEnd("character",0);Field.select(b);b.scrollIntoView(true)}}}function redirectSubmit(a){if($F("to")==""){alert(IMP.text.compose_recipient);$("to").focus();Event.extend(a);a.stop();return false}$("redirect").setStyle({cursor:"wait"});display_unload_warning=false;return true}function change_identity(a){var m=identities[$F("last_identity")],d=identities[a],b,e,g,l;if(rtemode){e=FCKeditorAPI.GetInstance("message");b=e.GetHTML.replace(/\r\n/g,"\n");g="<p><!--begin_signature--><!--end_signature--></p>";l="<p><!--begin_signature-->"+d[0].replace(/^ ?<br \/>\n/,"").replace(/ +/g," ")+"<!--end_signature--></p>";b=b.replace(/<p class="imp-signature">\s*<!--begin_signature-->[\s\S]*?<!--end_signature-->\s*<\/p>/,g)}else{b=$F("message").replace(/\r\n/g,"\n");g=m[0].replace(/^\n/,"");l=d[0].replace(/^\n/,"")}var k=(m[1])?b.indexOf(g):b.lastIndexOf(g);if(k!=-1){if(d[1]==m[1]){b=b.substring(0,k)+l+b.substring(k+g.length,b.length)}else{if(d[1]){b=l+b.substring(0,k)+b.substring(k+g.length,b.length)}else{b=b.substring(0,k)+b.substring(k+g.length,b.length)+l}}b=b.replace(/\r\n/g,"\n").replace(/\n/g,"\r\n");$("last_identity").setValue(a);window.status=IMP.text.compose_sigreplace}else{window.status=IMP.text.compose_signotreplace}if(rtemode){e.SetHTML(b)}else{$("message").setValue(b)}var j=$("sent_mail_folder");if(smf_check){var c=0;$A(j.options).detect(function(i){if(i.value==d[2]){j.selectedIndex=c;return true}++c})}else{if(j.firstChild){j.replaceChild(document.createTextNode(d[2]),j.firstChild)}else{j.appendChild(document.createTextNode(d[2]))}}var h=$("ssm");if(h){h.checked=d[3]}var f=$("bcc");if(f){bccval=f.value;if(m[4]){var n=new RegExp(m[4]+",? ?","gi");bccval=bccval.replace(n,"");if(bccval){bccval=bccval.replace(/, ?$/,"")}}if(d[4]){if(bccval){bccval+=", "}bccval+=d[4]}f.setValue(bccval)}}function uniqSubmit(b,a){if(a){Event.extend(a);a.stop()}if(b=="send_message"){if(($F("subject")=="")&&!window.confirm(IMP.text.compose_nosubject)){return}if(compose_spellcheck&&IMP.SpellCheckerObject&&!IMP.SpellCheckerObject.isActive()){IMP.SpellCheckerObject.spellCheck();return}}if(IMP.SpellCheckerObject){IMP.SpellCheckerObject.resume()}if(!Prototype.Browser.WebKit){$("compose").setStyle({cursor:"wait"})}display_unload_warning=false;$("actionID").setValue(b);_uniqSubmit()}function _uniqSubmit(){if(textarea_ready){$("compose").submit()}else{_uniqSubmit.defer()}}function attachmentChanged(){var a=[],e=0;$("upload_atc").select('input[type="file"]').each(function(g){a[a.length]=g});if(max_attachments!==null&&a.length==max_attachments){return}a.each(function(g){if(g.value.length>0){e++}});if(e==a.length){var d=$("attachment_row_"+e);if(d){var f=new Element("TD",{align:"left"}).insert(new Element("STRONG").insert(IMP.text.compose_file+" "+(e+1)+":")).insert("&nbsp;");var c=new Element("INPUT",{type:"file",name:"upload_"+(e+1),size:25});c.observe("change",attachmentChanged);f.insert(c);var b=new Element("TR",{id:"attachment_row_"+(e+1)}).insert(f);d.parentNode.insertBefore(b,d.nextSibling)}}}function initializeSpellChecker(){if(typeof IMP.SpellCheckerObject!="object"){initializeSpellChecker.defer();return}IMP.SpellCheckerObject.onBeforeSpellCheck=function(){IMP.SpellCheckerObject.htmlAreaParent="messageParent";IMP.SpellCheckerObject.htmlArea=$("message").adjacent("iframe[id*=message]").first();$("message").setValue(FCKeditorAPI.GetInstance("message").GetHTML());textarea_ready=false};IMP.SpellCheckerObject.onAfterSpellCheck=function(){IMP.SpellCheckerObject.htmlArea=IMP.SpellCheckerObject.htmlAreaParent=null;var a=FCKeditorAPI.GetInstance("message");a.SetHTML($("message").value);a.Events.AttachEvent("OnAfterSetHTML",function(){textarea_ready=true})}}document.observe("dom:loaded",function(){$$("INPUT").each(function(a){if(a.type!="submit"&&a.type!="button"){a.observe("keydown",function(b){if(b.keyCode==10||b.keyCode==Event.KEY_RETURN){b.stop();return false}})}});if(cursor_pos!==null&&$("message")){setCursorPosition($("message"),cursor_pos)}if(redirect){$("to").focus()}else{if(Prototype.Browser.IE){$("subject").observe("keydown",function(a){if(a.keyCode==Event.KEY_TAB&&!a.shiftKey){a.stop();$("message").focus()}})}if(rtemode){initializeSpellChecker()}if($("to")&&!$F("to")){$("to").focus()}else{if(!$F("subject")){if(rtemode){$("subject").focus()}else{$("message").focus()}}}}});Event.observe(window,"load",function(){if(compose_popup&&!reloaded){var b,a=redirect?$("redirect"):$("compose");b=Math.min(a.getHeight(),screen.height-100)-document.viewport.getHeight();if(b>0){window.resizeBy(0,b)}}});Event.observe(window,"beforeunload",function(){if(display_unload_warning){return IMP.text.compose_discard}});